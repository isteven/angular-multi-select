"use strict";angular.module("isteven-multi-select",["ng"]).directive("istevenMultiSelect",["$sce","$timeout","$templateCache",function(e,t,n){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",isDisabled:"=",onClear:"&",onClose:"&",onSearchChange:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},templateUrl:"isteven-multi-select.htm",link:function(n,r,l){function o(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",n="",r=0;e>r;r++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}n.backUp=[],n.varButtonLabel="",n.spacingProperty="",n.indexProperty="",n.orientationH=!1,n.orientationV=!0,n.filteredModel=[],n.inputLabel={labelFilter:""},n.tabIndex=0,n.lang={},n.helperStatus={all:!0,none:!0,reset:!0,filter:!0};var i=0,a=[],d=0,u="",p=[],s=0,c=null;n.clearClicked=function(e){n.inputLabel.labelFilter="",n.updateFilter(),n.select("clear",e)},n.numberToArray=function(e){return new Array(e)},n.searchChanged=function(){return n.inputLabel.labelFilter.length<s&&n.inputLabel.labelFilter.length>0?!1:void n.updateFilter()},n.updateFilter=function(){n.filteredModel=[];var e=0;if("undefined"==typeof n.inputModel)return!1;for(e=n.inputModel.length-1;e>=0;e--){"undefined"!=typeof n.inputModel[e][l.groupProperty]&&n.inputModel[e][l.groupProperty]===!1&&n.filteredModel.push(n.inputModel[e]);var r=!1;if("undefined"==typeof n.inputModel[e][l.groupProperty]){if("undefined"!=typeof l.searchProperty&&""!==l.searchProperty){for(var o in n.inputModel[e])if("boolean"!=typeof n.inputModel[e][o]&&String(n.inputModel[e][o]).toUpperCase().indexOf(n.inputLabel.labelFilter.toUpperCase())>=0&&l.searchProperty.indexOf(o)>-1){r=!0;break}}else for(var o in n.inputModel[e])if("boolean"!=typeof n.inputModel[e][o]&&String(n.inputModel[e][o]).toUpperCase().indexOf(n.inputLabel.labelFilter.toUpperCase())>=0){r=!0;break}r===!0&&n.filteredModel.push(n.inputModel[e])}"undefined"!=typeof n.inputModel[e][l.groupProperty]&&n.inputModel[e][l.groupProperty]===!0&&("undefined"!=typeof n.filteredModel[n.filteredModel.length-1][l.groupProperty]&&n.filteredModel[n.filteredModel.length-1][l.groupProperty]===!1?n.filteredModel.pop():n.filteredModel.push(n.inputModel[e]))}n.filteredModel.reverse(),t(function(){if(n.getFormElements(),n.inputLabel.labelFilter.length>s){var e=[];angular.forEach(n.filteredModel,function(t,r){if("undefined"!=typeof t&&"undefined"==typeof t[l.groupProperty]){var o=angular.copy(t),i=e.push(o);delete e[i-1][n.indexProperty],delete e[i-1][n.spacingProperty]}}),n.onSearchChange({data:{keyword:n.inputLabel.labelFilter,result:e}})}},0)},n.getFormElements=function(){p=[];var e=[],t=[],l=[],o=[];n.helperStatus.all||n.helperStatus.none||n.helperStatus.reset?(e=r.children().children().next().children().children()[0].getElementsByTagName("button"),n.helperStatus.filter&&(t=r.children().children().next().children().children().next()[0].getElementsByTagName("input"),o=r.children().children().next().children().children().next()[0].getElementsByTagName("button"))):n.helperStatus.filter&&(t=r.children().children().next().children().children()[0].getElementsByTagName("input"),o=r.children().children().next().children().children()[0].getElementsByTagName("button")),l=n.helperStatus.all||n.helperStatus.none||n.helperStatus.reset||n.helperStatus.filter?r.children().children().next().children().next()[0].getElementsByTagName("input"):r.children().children().next()[0].getElementsByTagName("input");for(var i=0;i<e.length;i++)p.push(e[i]);for(var i=0;i<t.length;i++)p.push(t[i]);for(var i=0;i<o.length;i++)p.push(o[i]);for(var i=0;i<l.length;i++)p.push(l[i])},n.isGroupMarker=function(e,t){return"undefined"!=typeof e[l.groupProperty]&&e[l.groupProperty]===t?!0:!1},n.removeGroupEndMarker=function(e){return"undefined"!=typeof e[l.groupProperty]&&e[l.groupProperty]===!1?!1:!0},n.syncItems=function(e,r,o){if(r.preventDefault(),r.stopPropagation(),"undefined"!=typeof l.disableProperty&&e[l.disableProperty]===!0)return!1;if("undefined"!=typeof l.isDisabled&&n.isDisabled===!0)return!1;if("undefined"!=typeof e[l.groupProperty]&&e[l.groupProperty]===!1)return!1;var a=n.filteredModel.indexOf(e);if("undefined"!=typeof e[l.groupProperty]&&e[l.groupProperty]===!0){if("undefined"!=typeof l.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase())return!1;var u,p,s=0,f=n.filteredModel.length-1,g=[],h=0;for(u=a;u<n.filteredModel.length&&!(0===h&&u>a);u++)if("undefined"!=typeof n.filteredModel[u][l.groupProperty]&&n.filteredModel[u][l.groupProperty]===!0)0===g.length&&(s=u+1),h+=1;else if("undefined"!=typeof n.filteredModel[u][l.groupProperty]&&n.filteredModel[u][l.groupProperty]===!1){if(h-=1,g.length>0&&0===h){var y=!0;for(f=u,p=0;p<g.length;p++)if("undefined"!=typeof g[p][n.tickProperty]&&g[p][n.tickProperty]===!1){y=!1;break}if(y===!0)for(p=s;f>=p;p++)"undefined"==typeof n.filteredModel[p][l.groupProperty]&&("undefined"==typeof l.disableProperty?(n.filteredModel[p][n.tickProperty]=!1,b=n.filteredModel[p][n.indexProperty],n.inputModel[b][n.tickProperty]=!1):n.filteredModel[p][l.disableProperty]!==!0&&(n.filteredModel[p][n.tickProperty]=!1,b=n.filteredModel[p][n.indexProperty],n.inputModel[b][n.tickProperty]=!1));else for(p=s;f>=p;p++)"undefined"==typeof n.filteredModel[p][l.groupProperty]&&("undefined"==typeof l.disableProperty?(n.filteredModel[p][n.tickProperty]=!0,b=n.filteredModel[p][n.indexProperty],n.inputModel[b][n.tickProperty]=!0):n.filteredModel[p][l.disableProperty]!==!0&&(n.filteredModel[p][n.tickProperty]=!0,b=n.filteredModel[p][n.indexProperty],n.inputModel[b][n.tickProperty]=!0))}}else g.push(n.filteredModel[u])}else{if("undefined"!=typeof l.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase()){for(u=0;u<n.filteredModel.length;u++)n.filteredModel[u][n.tickProperty]=!1;for(u=0;u<n.inputModel.length;u++)n.inputModel[u][n.tickProperty]=!1;n.filteredModel[a][n.tickProperty]=!0}else n.filteredModel[a][n.tickProperty]=!n.filteredModel[a][n.tickProperty];var b=n.filteredModel[a][n.indexProperty];n.inputModel[b][n.tickProperty]=n.filteredModel[a][n.tickProperty]}c=angular.copy(e),null!==c&&t(function(){delete c[n.indexProperty],delete c[n.spacingProperty],n.onItemClick({data:c}),c=null},0),n.refreshOutputModel(),n.refreshButton(),i=n.tabIndex,n.tabIndex=o+d,r.target.focus(),n.removeFocusStyle(i),n.setFocusStyle(n.tabIndex),"undefined"!=typeof l.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase()&&n.toggleCheckboxes(r)},n.refreshOutputModel=function(){n.outputModel=[];var e=[],t={};"undefined"!=typeof l.outputProperties?(e=l.outputProperties.split(" "),angular.forEach(n.inputModel,function(r,o){if("undefined"!=typeof r&&"undefined"==typeof r[l.groupProperty]&&r[n.tickProperty]===!0){t={},angular.forEach(r,function(n,r){e.indexOf(r)>-1&&(t[r]=n)});var i=n.outputModel.push(t);delete n.outputModel[i-1][n.indexProperty],delete n.outputModel[i-1][n.spacingProperty]}})):angular.forEach(n.inputModel,function(e,t){if("undefined"!=typeof e&&"undefined"==typeof e[l.groupProperty]&&e[n.tickProperty]===!0){var r=angular.copy(e),o=n.outputModel.push(r);delete n.outputModel[o-1][n.indexProperty],delete n.outputModel[o-1][n.spacingProperty]}})},n.refreshButton=function(){n.varButtonLabel="";var t=0;if(0===n.outputModel.length)n.varButtonLabel=n.lang.nothingSelected;else{var r=n.outputModel.length;"undefined"!=typeof l.maxLabels&&""!==l.maxLabels&&(r=l.maxLabels),n.outputModel.length>r?n.more=!0:n.more=!1,angular.forEach(n.inputModel,function(e,o){"undefined"!=typeof e&&e[l.tickProperty]===!0&&(r>t&&(n.varButtonLabel+=(n.varButtonLabel.length>0?'</div>, <div class="buttonLabel">':'<div class="buttonLabel">')+n.writeLabel(e,"buttonLabel")),t++)}),n.more===!0&&(r>0&&(n.varButtonLabel+=", ... "),n.varButtonLabel+="("+n.outputModel.length+")")}n.varButtonLabel=e.trustAsHtml(n.varButtonLabel+'<span class="caret"></span>')},n.itemIsDisabled=function(e){return"undefined"!=typeof l.disableProperty&&e[l.disableProperty]===!0?!0:n.isDisabled===!0?!0:!1},n.writeLabel=function(t,n){var r=l[n].split(" "),o="";return angular.forEach(r,function(e,n){t[e]&&(o+="&nbsp;"+e.split(".").reduce(function(e,t){return e[t]},t))}),"BUTTONLABEL"===n.toUpperCase()?o:e.trustAsHtml(o)},n.toggleCheckboxes=function(e){var l=r.children()[0];if(angular.element(document).off("click",n.externalClickListener),angular.element(document).off("keydown",n.keyboardListener),angular.element(u).hasClass("show"))angular.element(u).removeClass("show"),angular.element(l).removeClass("buttonClicked"),angular.element(document).off("click",n.externalClickListener),angular.element(document).off("keydown",n.keyboardListener),n.removeFocusStyle(n.tabIndex),"undefined"!=typeof p[n.tabIndex]&&p[n.tabIndex].blur(),t(function(){n.onClose()},0),r.children().children()[0].focus();else{n.inputLabel.labelFilter="",n.updateFilter(),a=[],d=0,angular.element(u).addClass("show"),angular.element(l).addClass("buttonClicked"),angular.element(document).on("click",n.externalClickListener),angular.element(document).on("keydown",n.keyboardListener),n.getFormElements(),n.tabIndex=0;var o=angular.element(r[0].querySelector(".helperContainer"))[0];if("undefined"!=typeof o){for(var i=0;i<o.getElementsByTagName("BUTTON").length;i++)a[i]=o.getElementsByTagName("BUTTON")[i];d=a.length+o.getElementsByTagName("INPUT").length}r[0].querySelector(".inputFilter")?(r[0].querySelector(".inputFilter").focus(),n.tabIndex=n.tabIndex+d-2,angular.element(r).children()[0].blur()):n.isDisabled||(n.tabIndex=n.tabIndex+d,n.inputModel.length>0&&(p[n.tabIndex].focus(),n.setFocusStyle(n.tabIndex),angular.element(r).children()[0].blur())),n.onOpen()}},n.externalClickListener=function(e){for(var l=r.find(e.target.tagName),o=0;o<l.length;o++)if(e.target==l[o])return;angular.element(u.previousSibling).removeClass("buttonClicked"),angular.element(u).removeClass("show"),angular.element(document).off("click",n.externalClickListener),angular.element(document).off("keydown",n.keyboardListener),t(function(){n.onClose()},0),r.children().children()[0].focus()},n.select=function(e,t){var r=a.indexOf(t.target);switch(n.tabIndex=r,e.toUpperCase()){case"ALL":angular.forEach(n.filteredModel,function(e,t){"undefined"!=typeof e&&e[l.disableProperty]!==!0&&"undefined"==typeof e[l.groupProperty]&&(e[n.tickProperty]=!0)}),n.refreshOutputModel(),n.refreshButton(),n.onSelectAll();break;case"NONE":angular.forEach(n.filteredModel,function(e,t){"undefined"!=typeof e&&e[l.disableProperty]!==!0&&"undefined"==typeof e[l.groupProperty]&&(e[n.tickProperty]=!1)}),n.refreshOutputModel(),n.refreshButton(),n.onSelectNone();break;case"RESET":angular.forEach(n.filteredModel,function(e,t){if("undefined"==typeof e[l.groupProperty]&&"undefined"!=typeof e&&e[l.disableProperty]!==!0){var r=e[n.indexProperty];e[n.tickProperty]=n.backUp[r][n.tickProperty]}}),n.refreshOutputModel(),n.refreshButton(),n.onReset();break;case"CLEAR":n.tabIndex=n.tabIndex+1,n.onClear();break;case"FILTER":n.tabIndex=a.length-1}},n.prepareGrouping=function(){var e=0;angular.forEach(n.filteredModel,function(t,r){t[n.spacingProperty]=e,t[l.groupProperty]===!0?e+=2:t[l.groupProperty]===!1&&(e-=2)})},n.prepareIndex=function(){var e=0;angular.forEach(n.filteredModel,function(t,r){t[n.indexProperty]=e,e++})},n.keyboardListener=function(e){var t=e.keyCode?e.keyCode:e.which,r=!1;if(27===t)e.preventDefault(),e.stopPropagation(),n.toggleCheckboxes(e);else if(40===t||39===t||!e.shiftKey&&9==t)for(r=!0,i=n.tabIndex,n.tabIndex++,n.tabIndex>p.length-1&&(n.tabIndex=0,i=p.length-1);p[n.tabIndex].disabled===!0&&(n.tabIndex++,n.tabIndex>p.length-1&&(n.tabIndex=0),n.tabIndex!==i););else if(38===t||37===t||e.shiftKey&&9==t)for(r=!0,i=n.tabIndex,n.tabIndex--,n.tabIndex<0&&(n.tabIndex=p.length-1,i=0);p[n.tabIndex].disabled===!0&&(n.tabIndex--,n.tabIndex!==i);)n.tabIndex<0&&(n.tabIndex=p.length-1);if(r===!0){e.preventDefault(),p[n.tabIndex].focus();var l=document.activeElement;"CHECKBOX"===l.type.toUpperCase()?(n.setFocusStyle(n.tabIndex),n.removeFocusStyle(i)):(n.removeFocusStyle(i),n.removeFocusStyle(d),n.removeFocusStyle(p.length-1))}r=!1},n.setFocusStyle=function(e){angular.element(p[e]).parent().parent().parent().addClass("multiSelectFocus")},n.removeFocusStyle=function(e){angular.element(p[e]).parent().parent().parent().removeClass("multiSelectFocus")},n.groupProperty=l.groupProperty,n.tickProperty=l.tickProperty,n.directiveId=l.directiveId;var f=o(5);if(n.indexProperty="idx_"+f,n.spacingProperty="spc_"+f,"undefined"!=typeof l.orientation&&("HORIZONTAL"===l.orientation.toUpperCase()?(n.orientationH=!0,n.orientationV=!1):(n.orientationH=!1,n.orientationV=!0)),u=r.children().children().next()[0],"undefined"!=typeof l.maxHeight){var g=r.children().children().children()[0];angular.element(g).attr("style","height:"+l.maxHeight+"; overflow-y:scroll;")}for(var h in n.helperStatus)n.helperStatus.hasOwnProperty(h)&&"undefined"!=typeof l.helperElements&&-1===l.helperElements.toUpperCase().indexOf(h.toUpperCase())&&(n.helperStatus[h]=!1);"undefined"!=typeof l.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase()&&(n.helperStatus.all=!1,n.helperStatus.none=!1),n.icon={},n.icon.selectAll="&#10003;",n.icon.selectNone="&times;",n.icon.reset="&#8630;",n.icon.tickMark="&#10003;","undefined"!=typeof l.translation?(n.lang.selectAll=e.trustAsHtml(n.icon.selectAll+"&nbsp;&nbsp;"+n.translation.selectAll),n.lang.selectNone=e.trustAsHtml(n.icon.selectNone+"&nbsp;&nbsp;"+n.translation.selectNone),n.lang.reset=e.trustAsHtml(n.icon.reset+"&nbsp;&nbsp;"+n.translation.reset),n.lang.search=n.translation.search,n.lang.nothingSelected=e.trustAsHtml(n.translation.nothingSelected)):(n.lang.selectAll=e.trustAsHtml(n.icon.selectAll+"&nbsp;&nbsp;Select All"),n.lang.selectNone=e.trustAsHtml(n.icon.selectNone+"&nbsp;&nbsp;Select None"),n.lang.reset=e.trustAsHtml(n.icon.reset+"&nbsp;&nbsp;Reset"),n.lang.search="Search...",n.lang.nothingSelected="None Selected"),n.icon.tickMark=e.trustAsHtml(n.icon.tickMark),"undefined"!=typeof l.MinSearchLength&&parseInt(l.MinSearchLength)>0&&(s=Math.floor(parseInt(l.MinSearchLength))),n.$watch("inputModel",function(e){e&&(n.refreshOutputModel(),n.refreshButton())},!0),n.$watch("inputModel",function(e){e&&(n.backUp=angular.copy(n.inputModel),n.updateFilter(),n.prepareGrouping(),n.prepareIndex(),n.refreshOutputModel(),n.refreshButton())}),n.$watch("isDisabled",function(e){n.isDisabled=e});var y=function(e){n.$apply(function(){n.scrolled=!1})};angular.element(document).bind("touchstart",y);var b=function(e){n.$apply(function(){n.scrolled=!0})};angular.element(document).bind("touchmove",b),n.$on("$destroy",function(){angular.element(document).unbind("touchstart",y),angular.element(document).unbind("touchmove",b)})}}}]).run(["$templateCache",function(e){var t='<span class="multiSelect inlineBlock"><button id="{{directiveId}}" type="button"ng-click="toggleCheckboxes( $event ); refreshSelectedItems(); refreshButton(); prepareGrouping; prepareIndex();"ng-bind-html="varButtonLabel"ng-disabled="disable-button"></button><div class="checkboxLayer"><div class="helperContainer" ng-if="helperStatus.filter || helperStatus.all || helperStatus.none || helperStatus.reset "><div class="line" ng-if="helperStatus.all || helperStatus.none || helperStatus.reset "><button type="button" class="helperButton"ng-disabled="isDisabled"ng-if="helperStatus.all"ng-click="select( \'all\', $event );"ng-bind-html="lang.selectAll"></button><button type="button" class="helperButton"ng-disabled="isDisabled"ng-if="helperStatus.none"ng-click="select( \'none\', $event );"ng-bind-html="lang.selectNone"></button><button type="button" class="helperButton reset"ng-disabled="isDisabled"ng-if="helperStatus.reset"ng-click="select( \'reset\', $event );"ng-bind-html="lang.reset"></button></div><div class="line" style="position:relative" ng-if="helperStatus.filter"><input placeholder="{{lang.search}}" type="text"ng-click="select( \'filter\', $event )" ng-model="inputLabel.labelFilter" ng-change="searchChanged()" class="inputFilter"/><button type="button" class="clearButton" ng-click="clearClicked( $event )" >×</button> </div> </div> <div class="checkBoxContainer"><div ng-repeat="item in filteredModel | filter:removeGroupEndMarker" class="multiSelectItem"ng-class="{selected: item[ tickProperty ], horizontal: orientationH, vertical: orientationV, multiSelectGroup:item[ groupProperty ], disabled:itemIsDisabled( item )}"ng-click="syncItems( item, $event, $index );" ng-mouseleave="removeFocusStyle( tabIndex );"> <div class="acol" ng-if="item[ spacingProperty ] > 0" ng-repeat="i in numberToArray( item[ spacingProperty ] ) track by $index"></div>  <div class="acol"><label><input class="checkbox focusable" type="checkbox" ng-disabled="itemIsDisabled( item )" ng-checked="item[ tickProperty ]" ng-click="syncItems( item, $event, $index )" /><span ng-class="{disabled:itemIsDisabled( item )}" ng-bind-html="writeLabel( item, \'itemLabel\' )"></span></label></div><span class="tickMark" ng-if="item[ groupProperty ] !== true && item[ tickProperty ] === true" ng-bind-html="icon.tickMark"></span></div></div></div></span>';e.put("isteven-multi-select.htm",t)}]);